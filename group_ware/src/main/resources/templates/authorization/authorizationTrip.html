<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{include/layout}">
     <th:block layout:fragment="content">
     <link th:href="@{/css/authorization/authorizationCreate.css}" rel="stylesheet" type="text/css">
     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
      	<section>
      		<div id="section_wrap">
      			<form id="authorizationAddFrm" enctype="multipart/form-data">
      				<div id="section" class="form-section">
      					<!-- 상태 필드 숨기기 -->
      					<input type="hidden" id="documentStatus" name="documentStatus" value="미승인">
      					<label>문서 종류</label>
			            <select>
			                <option>해외 출장 보고서</option>
			            </select>
			            <label>부서</label>
			            <select>
			                <option>전체</option>
			            </select>
			            <label>결재자</label>
			            <select>
			                <option>전체</option>
			            </select>
			            <label>참조자</label>
			            <select>
			                <option>전체</option>
			            </select>
	      			</div>

					<div class="ckeditor_change">
				        <textarea id="document-editor" name="content"></textarea>
				    </div>
					<div class="fileuploadstart">
						<input type="file" name="content">
					</div> 
					<div class="submitButton">
						<input type="submit" value="결재요청">
					    <input type="submit" value="임시저장">
					    <input type="button" value="취소">
					</div>
				</form>
			</div>
		</section>
		<script src="https://cdn.ckeditor.com/ckeditor5/35.4.0/classic/ckeditor.js"></script>
		<script>
			 ClassicEditor
		        .create(document.querySelector('#document-editor'), {
		            toolbar: {
		                items: [
		                    'heading', '|',
		                    'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', '|',
		                    'insertTable', 'imageUpload', '|',
		                    'undo', 'redo'
		                ]
		            },
		            height: 500,  // 에디터 높이 설정
		            width: '100%',  // 에디터 너비 설정
		            ckfinder: {
		                uploadUrl: '/authorization/document/upload'  // 파일 업로드를 위한 URL 설정
		            },
		            image: {
		                toolbar: [
		                    'imageTextAlternative', 'imageStyle:full', 'imageStyle:side'
		                ]
		            },
		            table: {
		                contentToolbar: [
		                    'tableColumn', 'tableRow', 'mergeTableCells'
		                ]
		            },
		        })
		        .then(editor => {
		            window.editor = editor;

		            // Set initial content
		            editor.setData(`
		                <table style="width: 100%; border: 1px solid #000; border-collapse: collapse;">
		                    <tr>
		                        <td style="border: 1px solid #000; padding: 5px; width: 20%; height: 40px;">소속</td>
		                        <td style="border: 1px solid #000; padding: 5px; width: 30%;"></td>
		                        <td style="border: 1px solid #000; padding: 5px; width: 20%; height: 40px;">성명</td>
		                        <td style="border: 1px solid #000; padding: 5px; width: 30%;"></td>
		                    </tr>
		                    <tr>
		                        <td style="border: 1px solid #000; padding: 5px; width: 20%; height: 40px;">사원번호</td>
		                        <td style="border: 1px solid #000; padding: 5px; width: 30%;"></td>
		                    </tr>
		                </table>
		                <br>
		                <table style="width: 100%; border: 1px solid #000; border-collapse: collapse;">
		                    <tr>
		                        <td colspan="4" style="border: 1px solid #000; padding: 5px; text-align: center;">해외 출장 보고서</td>
		                    </tr>
		                    <tr>
		                        <td style="border: 1px solid #000; padding: 5px; width: 20%;">제목</td>
		                        <td colspan="3" style="border: 1px solid #000; padding: 5px;"></td>
		                    </tr>
		                    <tr>
		                        <td style="border: 1px solid #000; padding: 5px;">출장 구분</td>
		                        <td colspan="3" style="border: 1px solid #000; padding: 5px;"></td>
		                    </tr>
		                    <tr>
		                        <td style="border: 1px solid #000; padding: 5px;">시작 일정</td>
		                        <td style="border: 1px solid #000; padding: 5px;"></td>
		                        <td style="border: 1px solid #000; padding: 5px;">종료 일정</td>
		                        <td style="border: 1px solid #000; padding: 5px;"></td>
		                    </tr>
		                </table>
		                <br>
		                <p>* '해외 출장 관련' 작성란은 생략되었습니다.</p>
		                <p>* 중간/최종 출장 보고서 등을 작성할 경우 반드시 기안일에 적어주세요.</p>
		                <p>1. 해외 출장은 회사의 승인을 받은 후에만 진행 가능합니다. 출장 일정과 계획은 출발 전 충분한 시간을 두고 제출해야 합니다.</p>
		                <p>2. 출장자는 출장을 통해 수행한 업무에 대해 명확하고 구체적인 출장 보고서를 제출해야 하며, 필요시 출장 중 발생한 모든 비용에 대한 증빙 서류를 첨부해야 합니다.</p>
		                <p>3. 출장 중 발생한 긴급 상황에 대해서는 즉시 보고하여야 하며, 귀국 후 가능한 한 빠르게 최종 출장 보고서를 제출해야 합니다.</p>
		                <p>4. 중간 출장 보고서와 최종 출장 보고서는 회사 내부 규정에 따라 제출되어야 하며, 필요 시 추가적인 자료나 설명을 요구받을 수 있습니다.</p>
		            `);
		        })
		        .catch(error => {
		            console.error('There was a problem initializing the editor:', error);
		        });
						    // 폼 제출 이벤트 처리
			    const form = document.getElementById("authorizationAddFrm");
			    form.addEventListener('submit', (e) => {
			        e.preventDefault();
			        let vali_check = false;
			        let vali_text = "";
			
			        // CKEditor 내용 가져오기
			        const content = editor.getData();
			
			        if (content == "") {
			            vali_text += "내용을 입력하세요.";
			            editor.focus();
			        } else {
			            vali_check = true;
			        }
			
			        if (!vali_check) {
			            alert(vali_text);
			        } else {
			            const payload = new FormData(form);
			            payload.set('content', content);  // CKEditor 내용 추가
			
			            fetch('/authorization', {
			                method: 'POST',
			                body: payload
			            })
			            .then(response => response.json())
			            .then(data => {
			                if (data.res_code == '200') {
			                    Swal.fire({
			                        icon: 'success',
			                        title: '성공',
			                        text: data.res_msg,
			                        confirmButtonText: "닫기"
			                    }).then((result) => {
			                        location.href = "/authorization/list";
			                    });
			                } else {
			                    Swal.fire({
			                        icon: 'error',
			                        title: '실패',
			                        text: data.res_msg,
			                        confirmButtonText: "닫기"
			                    });
			                }
			            });
			        }
			    });
			</script>
     </th:block>
</html>
